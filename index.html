<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>3D Танки – Реалистичная графика</title>
<style>
body { margin:0; overflow:hidden; background:#87ceeb; font-family:sans-serif; }
#score { position:absolute; top:10px; left:10px; color:white; font-size:24px; font-weight:bold; z-index:100; }
</style>
</head>
<body>
<div id="score">Очки: 0</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<script>
// -------------------- СЦЕНА --------------------
const scene = new THREE.Scene();

// -------------------- КАМЕРА --------------------
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0, 6, 12);

// -------------------- РЕНДЕР --------------------
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

// -------------------- СВЕТ --------------------
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(10,20,10);
light.castShadow = true;
scene.add(light);

const ambient = new THREE.AmbientLight(0x888888);
scene.add(ambient);

// -------------------- ЗЕМЛЯ --------------------
const groundTex = new THREE.TextureLoader().load('https://threejs.org/examples/textures/terrain/grasslight-big.jpg');
groundTex.wrapS = groundTex.wrapT = THREE.RepeatWrapping;
groundTex.repeat.set(10,10);

const groundMat = new THREE.MeshStandardMaterial({map: groundTex});
const ground = new THREE.Mesh(new THREE.PlaneGeometry(50,50), groundMat);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// -------------------- ТАНК --------------------
class Tank {
    constructor(color=0x00ff00){
        this.group = new THREE.Group();

        const bodyMat = new THREE.MeshStandardMaterial({color, metalness:0.7, roughness:0.3});
        const body = new THREE.Mesh(new THREE.BoxGeometry(2,0.5,3), bodyMat);
        body.castShadow = true;
        this.group.add(body);

        const turret = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.4,16), new THREE.MeshStandardMaterial({color:0x333333, metalness:0.7, roughness:0.2}));
        turret.position.y = 0.45;
        turret.castShadow = true;
        this.group.add(turret);
        this.turret = turret;

        const barrel = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,2), new THREE.MeshStandardMaterial({color:0x333333, metalness:0.7, roughness:0.2}));
        barrel.position.set(0,0.45,1.5);
        barrel.castShadow = true;
        this.group.add(barrel);
        this.barrel = barrel;

        this.bullets = [];
        this.speed = 0.2;
        this.rotSpeed = 0.05;

        scene.add(this.group);
    }

    move(keys){
        if(keys['w']){
            this.group.position.x -= Math.sin(this.group.rotation.y)*this.speed;
            this.group.position.z -= Math.cos(this.group.rotation.y)*this.speed;
        }
        if(keys['s']){
            this.group.position.x += Math.sin(this.group.rotation.y)*this.speed;
            this.group.position.z += Math.cos(this.group.rotation.y)*this.speed;
        }
        if(keys['a']) this.group.rotation.y += this.rotSpeed;
        if(keys['d']) this.group.rotation.y -= this.rotSpeed;
    }

    shoot(){
        const bullet = new Bullet(
            this.group.position.x + Math.sin(this.group.rotation.y)*2,
            this.group.position.z + Math.cos(this.group.rotation.y)*2,
            this.group.rotation.y
        );
        this.bullets.push(bullet);
    }

    updateBullets(){
        this.bullets.forEach(b => b.update());
        this.bullets = this.bullets.filter(b => b.alive);
    }
}

// -------------------- ПУЛЯ --------------------
class Bullet {
    constructor(x,z,angle){
        this.mesh = new THREE.Mesh(new THREE.SphereGeometry(0.2,12,12), new THREE.MeshStandardMaterial({color:0xffff00, metalness:0.6}));
        this.mesh.position.set(x,0.3,z);
        this.angle = angle;
        this.speed = 0.4;
        this.alive = true;
        scene.add(this.mesh);
    }

    update(){
        this.mesh.position.x -= Math.sin(this.angle)*this.speed;
        this.mesh.position.z -= Math.cos(this.angle)*this.speed;

        if(Math.abs(this.mesh.position.x)>25 || Math.abs(this.mesh.position.z)>25){
            scene.remove(this.mesh);
            this.alive=false;
        }

        enemies.forEach(enemy=>{
            if(!enemy.alive) return;
            const dx = this.mesh.position.x - enemy.group.position.x;
            const dz = this.mesh.position.z - enemy.group.position.z;
            if(Math.sqrt(dx*dx + dz*dz)<1.5){
                scene.remove(enemy.group);
                scene.remove(this.mesh);
                enemy.alive=false;
                this.alive=false;
                score++;
                document.getElementById('score').innerText = "Очки: "+score;
            }
        });
    }
}

// -------------------- ВРАГ --------------------
class Enemy {
    constructor(){
        this.group = new THREE.Group();
        const bodyMat = new THREE.MeshStandardMaterial({color:0xff0000, metalness:0.7, roughness:0.3});
        const body = new THREE.Mesh(new THREE.BoxGeometry(2,0.5,3), bodyMat);
        body.castShadow=true;
        this.group.add(body);
        this.group.position.set(Math.random()*20-10,0,Math.random()*20-10);
        scene.add(this.group);
        this.speed = 0.05;
        this.alive=true;
    }

    moveTowards(target){
        const dx = target.group.position.x - this.group.position.x;
        const dz = target.group.position.z - this.group.position.z;
        const angle = Math.atan2(dx,dz);
        this.group.rotation.y = angle;
        this.group.position.x += Math.sin(angle)*this.speed;
        this.group.position.z += Math.cos(angle)*this.speed;
    }
}

// -------------------- ИГРОВАЯ ЛОГИКА --------------------
const player = new Tank();
const keys = {};
document.addEventListener('keydown', e=> keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup', e=> keys[e.key.toLowerCase()]=false);
document.addEventListener('click', ()=> player.shoot());

let score=0;
const enemies = [];
for(let i=0;i<5;i++) enemies.push(new Enemy());

// -------------------- АНИМАЦИЯ --------------------
function animate(){
    requestAnimationFrame(animate);
    player.move(keys);
    player.updateBullets();

    enemies.forEach(e=> {if(e.alive) e.moveTowards(player);});

    camera.position.x = player.group.position.x + 10*Math.sin(player.group.rotation.y);
    camera.position.z = player.group.position.z + 10*Math.cos(player.group.rotation.y);
    camera.position.y = 6;
    camera.lookAt(player.group.position);

    renderer.render(scene,camera);
}

animate();

// -------------------- АДАПТАЦИЯ --------------------
window.addEventListener('resize',()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>

